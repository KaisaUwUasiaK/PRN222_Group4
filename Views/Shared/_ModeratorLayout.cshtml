<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - ComicVerse Moderator</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/%40phosphor-icons/web"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="~/css/variables.css">
    <link rel="stylesheet" href="~/css/style.css">
    <link rel="stylesheet" href="~/css/admin.css">
    <link rel="stylesheet" href="~/css/moderator.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css" />

    @await RenderSectionAsync("Styles", required: false)
</head>

<body>

@{
    var moderatorName = User.Identity?.Name ?? "Moderator";
    var avatarClaim = User.Claims.FirstOrDefault(c => c.Type == "AvatarUrl")?.Value;
    var moderatorAvatar = !string.IsNullOrEmpty(avatarClaim)
        ? avatarClaim
        : $"https://ui-avatars.com/api/?name={Uri.EscapeDataString(moderatorName)}&background=8b5cf6&color=fff&size=40";

    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
}

<div class="admin-wrapper">

    <!-- ── Sidebar ── -->
    <aside class="admin-sidebar">

        <!-- Logo -->
        <a href="@Url.Action("Dashboard", "Moderation")" class="sidebar-logo">
            <i class="ph-fill ph-book-open-text" style="font-size: 1.6rem; color: #8b5cf6;"></i>
            <span class="sidebar-logo-text">ComicVerse</span>
            <span class="sidebar-logo-badge" style="background: #8b5cf6;">Mod</span>
        </a>

        <!-- Overview -->
        <div class="nav-group">
            <div class="nav-group-label">Overview</div>
            <a href="@Url.Action("Dashboard", "Moderation")"
               class="nav-item @(currentAction == "Dashboard" ? "active" : "")">
                <i class="ph ph-squares-four"></i>
                <span>Dashboard</span>
            </a>
        </div>

        <!-- Moderation -->
        <div class="nav-group">
            <div class="nav-group-label">Moderation</div>
            <a href="@Url.Action("Pending", "Moderation")"
               class="nav-item @(currentAction == "Pending" ? "active" : "")">
                <i class="ph ph-hourglass"></i>
                <span>Pending Comics</span>
            </a>
            <a href="@Url.Action("UserReports", "Report")"
               class="nav-item @(currentAction == "UserReports" ? "active" : "")">
                <i class="ph ph-flag"></i>
                <span>User Reports</span>
                @if (ViewBag.PendingUserReportsCount > 0)
                {
                    <span class="nav-badge">@ViewBag.PendingUserReportsCount</span>
                }
            </a>
        </div>

        <!-- Spacer pushes bottom items down -->
        <div class="nav-spacer"></div>

        <!-- Bottom -->
        <div class="nav-group" style="margin-bottom: 0;">
            <a href="@Url.Action("Index", "Home")" class="nav-item">
                <i class="ph ph-house"></i>
                <span>Back to Home</span>
            </a>
            <a href="@Url.Action("Logout", "Authentication")" class="nav-item nav-item-danger">
                <i class="ph ph-sign-out"></i>
                <span>Logout</span>
            </a>
        </div>

    </aside>

    <!-- ── Main ── -->
    <div class="admin-main">

        <!-- Top Bar -->
        <header class="admin-topbar">
            <div class="topbar-breadcrumb">
                <a href="@Url.Action("Dashboard", "Moderation")">Moderator</a>
                @if (ViewData["Breadcrumb"] != null)
                {
                    <span class="sep">/</span>
                    <span>@ViewData["Breadcrumb"]</span>
                }
            </div>

            <div class="topbar-actions">
                <button class="btn btn-ghost" style="padding: 8px; position: relative;" title="Notifications">
                    <i class="ph ph-bell" style="font-size: 1.1rem;"></i>
                </button>

                <div class="dropdown">
                    <div class="dropdown-trigger" style="gap: 8px; padding: 4px 8px; border-radius: var(--radius-sm);">
                        <img src="@moderatorAvatar" alt="Moderator" class="topbar-avatar">
                        <span class="topbar-username">@moderatorName</span>
                        <i class="ph-bold ph-caret-down dropdown-arrow" style="font-size: 0.75rem;"></i>
                    </div>
                    <div class="dropdown-content" style="right: 0; min-width: 180px;">
                        <a href="@Url.Action("Logout", "Authentication")" class="dropdown-item" style="color: var(--color-danger);">
                            <i class="ph ph-sign-out"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="admin-content">
            @RenderBody()
        </div>

    </div>
</div>

<!-- Scripts -->
<script src="~/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const notyf = new Notyf({ duration: 4000, position: { x: 'right', y: 'top' }, dismissible: true });

        @if (TempData["Success"] != null)
        {
            <text>notyf.success("@TempData["Success"]");</text>
        }
        @if (TempData["Error"] != null)
        {
            <text>notyf.error("@TempData["Error"]");</text>
        }
    });

    // Dropdown toggle
    document.querySelectorAll('.dropdown-trigger').forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            this.closest('.dropdown').classList.toggle('active');
        });
    });

    document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown.active').forEach(d => d.classList.remove('active'));
    });
</script>

@if (User.Identity?.IsAuthenticated == true)
{
    <script>
        const statusConnection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/userStatus")
            .withAutomaticReconnect()
            .build();
        statusConnection.start().catch(err => console.error("SignalR error:", err));
    </script>
}

@await RenderSectionAsync("Scripts", required: false)

</body>
</html>