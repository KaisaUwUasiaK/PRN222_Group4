@using System.IO
@model Group4_ReadingComicWeb.Models.Chapter

@{
    Layout = null;
    var prevChapterId = ViewBag.PrevChapterId;
    var nextChapterId = ViewBag.NextChapterId;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@Model.Comic.Title - Chapter @Model.ChapterNumber</title>

    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-reader: #0a0a0a;
            --nav-bg: rgba(18, 18, 18, 0.95);
            --primary: #3b82f6;
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg-reader);
            color: #ececec;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }

        .reader-nav {
            background: var(--nav-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
        }

        .comic-image {
            display: block;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            height: auto;
        }

        /* Tối ưu lại nút điều hướng */
        .btn-nav {
            padding: 10px 20px;
            border-radius: 8px;
            background: #202020;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            color: #ccc;
        }

            .btn-nav:hover:not(.disabled) {
                background: #2a2a2a;
                color: white;
                border-color: rgba(255,255,255,0.2);
            }

            .btn-nav.primary {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

                .btn-nav.primary:hover {
                    background: #2563eb;
                }

            .btn-nav.disabled {
                opacity: 0.4;
                cursor: not-allowed;
                pointer-events: none;
            }

        .btn-icon-only {
            padding: 10px;
            border-radius: 8px;
            background: #202020;
            border: 1px solid var(--border);
            color: #ccc;
            display: grid;
            place-items: center;
            transition: 0.2s;
        }

            .btn-icon-only:hover {
                background: #2a2a2a;
                color: white;
            }

        #scrollTop {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: none;
            place-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 100;
            cursor: pointer;
            transition: 0.3s;
        }

            #scrollTop:hover {
                transform: translateY(-3px);
                background: #2563eb;
            }
    </style>
</head>
<body>

    <nav class="reader-nav sticky top-0 z-50 p-3">
        <div class="container mx-auto flex justify-between items-center max-w-[1200px]">
            <div class="flex items-center gap-4">
                <a href="@Url.Action("Detail", "Comic", new { id = Model.ComicId })" class="btn-icon-only" title="Back to Catalogue">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <div class="hidden md:block">
                    <h1 class="font-bold text-sm truncate max-w-md text-white">@Model.Comic.Title</h1>
                    <p class="text-xs text-gray-400">Chapter @Model.ChapterNumber: @Model.Title</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <a href="@(prevChapterId != null ? Url.Action("Read", "Comic", new { id = prevChapterId }) : "#")"
                   class="btn-icon-only @(prevChapterId == null ? "disabled" : "")" title="Previous Chapter">
                    <i class="ph ph-caret-left text-lg"></i>
                </a>

                <a href="@Url.Action("Detail", "Comic", new { id = Model.ComicId })" class="btn-icon-only" title="Catalogue">
                    <i class="ph ph-list-dashes text-lg"></i>
                </a>

                <a href="@(nextChapterId != null ? Url.Action("Read", "Comic", new { id = nextChapterId }) : "#")"
                   class="btn-icon-only @(nextChapterId == null ? "disabled" : "")" title="Next Chapter">
                    <i class="ph ph-caret-right text-lg"></i>
                </a>
            </div>
        </div>
    </nav>

    <main class="content-area py-8">
        <div class="flex flex-col">
            @{
                var currentDir = System.IO.Directory.GetCurrentDirectory();
                var relativePath = Model.Path.TrimStart('/');
                var folderPath = System.IO.Path.Combine(currentDir, "wwwroot", relativePath);

                if (System.IO.Directory.Exists(folderPath))
                {
                    var imageFiles = System.IO.Directory.GetFiles(folderPath)
                    .Where(f => f.EndsWith(".jpg") || f.EndsWith(".png") || f.EndsWith(".jpeg") || f.EndsWith(".webp"))
                    .Select(System.IO.Path.GetFileName)
                    .OrderBy(f => f);

                    foreach (var fileName in imageFiles)
                    {
                        var cleanPath = Model.Path.EndsWith("/") ? Model.Path : Model.Path + "/";
                        var imgSrc = $"{cleanPath}{fileName}";
                        <img src="@imgSrc" class="comic-image" loading="lazy" onerror="this.style.display='none'" alt="Comic Page" />
                    }
                }
                else
                {
                    <div class="text-center py-20 bg-[#121212] mx-4 rounded-xl border border-white/5 max-w-[900px] md:mx-auto">
                        <i class="ph ph-image-broken text-4xl text-gray-600 mb-3"></i>
                        <p class="text-gray-400">Images not found for this chapter.</p>
                    </div>
                }
            }
        </div>

        <div class="max-w-[900px] mx-auto mt-12 mb-6 px-4 flex justify-center items-center gap-4">
            <a href="@(prevChapterId != null ? Url.Action("Read", "Comic", new { id = prevChapterId }) : "#")"
               class="btn-nav @(prevChapterId == null ? "disabled" : "")">
                <i class="ph ph-arrow-left"></i> <span class="hidden md:inline">Prev Chapter</span>
            </a>

            <a href="@Url.Action("Detail", "Comic", new { id = Model.ComicId })" class="btn-nav" title="Catalogue">
                <i class="ph ph-squares-four text-xl"></i>
            </a>

            <a href="@(nextChapterId != null ? Url.Action("Read", "Comic", new { id = nextChapterId }) : "#")"
               class="btn-nav primary @(nextChapterId == null ? "disabled" : "")">
                <span class="hidden md:inline">Next Chapter</span> <i class="ph ph-arrow-right"></i>
            </a>
        </div>

        <div class="max-w-[900px] mx-auto mt-8 p-6 md:p-8 bg-[#121212] rounded-2xl border border-white/5 shadow-xl">
            <div class="flex items-center gap-3 mb-8 border-b border-white/5 pb-4">
                <i class="ph-fill ph-chat-teardrop-text text-2xl text-blue-500"></i>
                <h3 class="text-xl font-bold text-white">Comments (@(Model.Comments?.Count ?? 0))</h3>
            </div>

            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl mb-6 flex items-center gap-3 animate-pulse">
                        <i class="ph-fill ph-warning-circle text-xl"></i>
                        <p class="font-medium text-sm">@TempData["ErrorMessage"]</p>
                    </div>
                }

                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="bg-green-500/10 border border-green-500/20 text-green-400 px-4 py-3 rounded-xl mb-6 flex items-center gap-3">
                        <i class="ph-fill ph-check-circle text-xl"></i>
                        <p class="font-medium text-sm">@TempData["SuccessMessage"]</p>
                    </div>
                }
                <form action="@Url.Action("AddComment", "Comic")" method="post" class="mb-10">
                    <input type="hidden" name="ChapterId" value="@Model.ChapterId" />
                    <div class="flex flex-col gap-3">
                        <textarea name="Content" rows="3" required
                              class="w-full bg-[#1a1a1a] text-white border border-white/10 rounded-xl p-4 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all resize-y"
                              placeholder="What are your thoughts on this chapter?..."></textarea>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 px-6 rounded-lg transition-colors flex items-center gap-2">
                                <span>Post Comment</span> <i class="ph ph-paper-plane-right"></i>
                            </button>
                        </div>
                    </div>
                </form>
            }
            else
            {
                <div class="bg-[#1a1a1a] p-8 rounded-xl text-center mb-10 border border-white/5 flex flex-col items-center justify-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-500/10 flex items-center justify-center">
                        <i class="ph ph-lock-key text-2xl text-blue-400"></i>
                    </div>
                    <p class="text-gray-400">You must be logged in to join the discussion.</p>
                    <a href="/Authentication/Login" class="px-6 py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-white font-medium transition-colors">
                        Login to Comment
                    </a>
                </div>
            }

            <div class="space-y-8">
                @if (Model.Comments != null && Model.Comments.Any())
                {
                    foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                    {
                        <div class="flex gap-4 group">
                            <div class="w-10 h-10 md:w-12 md:h-12 shrink-0 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 font-bold overflow-hidden border border-white/10">
                                @if (!string.IsNullOrEmpty(comment.User.AvatarUrl))
                                {
                                    <img src="@comment.User.AvatarUrl" class="w-full h-full object-cover" alt="@comment.User.Username" onerror="this.style.display='none'" />
                                }
                                else
                                {
                                    @comment.User.Username.Substring(0, 1).ToUpper()
                                }
                            </div>

                            <div class="flex-1 w-full bg-[#161616] rounded-2xl rounded-tl-none p-4 border border-white/5">
                                <div class="flex justify-between items-start w-full mb-2">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="font-bold text-blue-400 text-sm md:text-base">@comment.User.Username</span>
                                        <span class="text-xs text-gray-500 flex items-center gap-1">
                                            <i class="ph ph-clock"></i> @comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                        </span>
                                    </div>

                                    @if (User.Identity != null && User.Identity.IsAuthenticated && User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == comment.UserId.ToString())
                                    {
                                        <form action="@Url.Action("DeleteComment", "Comic")" method="post" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                            <input type="hidden" name="commentId" value="@comment.CommentId" />
                                            <input type="hidden" name="chapterId" value="@comment.ChapterId" />
                                            <input type="hidden" name="source" value="Read" />

                                            <button type="submit" class="text-gray-600 hover:text-red-500 transition-colors p-1" title="Delete">
                                                <i class="ph ph-trash text-base md:text-lg"></i>
                                            </button>
                                        </form>
                                    }
                                </div>

                                <p class="text-gray-300 text-sm md:text-base leading-relaxed break-words whitespace-pre-wrap">@comment.Content</p>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-10 opacity-50">
                        <i class="ph ph-chat-teardrop-slash text-4xl mb-3"></i>
                        <p>No comments yet. Be the first to share your thoughts!</p>
                    </div>
                }
            </div>
        </div>
    </main>

    <button id="scrollTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="Back to Top">
        <i class="ph-bold ph-caret-up text-white"></i>
    </button>

    <script>
        window.onscroll = function() {
            let btn = document.getElementById("scrollTop");
            if (document.body.scrollTop > 500 || document.documentElement.scrollTop > 500) {
                btn.style.display = "grid";
            } else {
                btn.style.display = "none";
            }
        };
    </script>

</body>
</html>